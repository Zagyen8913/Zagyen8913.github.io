<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    
    textarea {
        
        position:absolute;
        width:50vw;
        top:2vw;
        height:calc(100vh - 2vw);
        left:0;
        display:inline-block;
        resize: none;
        
    }
    
    canvas {
        
        
        position: absolute;
        width: auto;
        left: 0;
        top: calc(50vh + 1vw);
        display: none;
        resize: none;
        
        
    }
    
    .screenCompActive textarea, .screenCompActive canvas {
        
        
        height:calc(50vh - 1vw);
        display:inline-block;
        
    }
    
    
    #lustlaOutput {
        
        
        position: absolute;
        left: 50vw;
        top: 2vw;
        width: 50vw;
        height: calc(100vh - 2vw);
        display: inline-block;
        font-family: monospace;
        
        
    }
    
    button {
        
        position:absolute;
        top:0;
        height:2vw;
        width:4vw;
        font-size:1vw;
        left: 46vw;
        
    }
    
</style>

<button style="" onclick="document.querySelector('#lustlaOutput').innerHTML = '';lustla.run(document.querySelector('#input').value);clearScreen();">Run</button>

<textarea  spellcheck="false" id="input" style="">
log:Hello!;
log:;
log:Welcome to Lustla, a special programming language;
log:designed to allow users to safely add code to a;
log:video game, without using dangerous languages such;
log:as JavaScript!;
</textarea>
<canvas id="screen" width=800 height=400></canvas>
<div id="lustlaOutput" style=""></div>
<script src="/lustla.js"></script>
<script src="behave.min.js"></script>
<script>
window.onload = function(){
    
    var editor = new Behave({
        textarea: document.querySelector("#input"),
        replaceTab: true,
        softTabs: true,
        tabSize: 4,
        autoOpen: true,
        overwrite: true,
        autoStrip: true,
        autoIndent: true,
        fence: false
    });
    
    c = document.querySelector("#screen");
    ctx = c.getContext("2d");
    
    window.clearScreen = function() {
        
        ctx.clearRect(0, 0, c.width, c.height);
        
    }
    
    
    
    lustla.addComp("screen", function(input) {
        
        type = input.split(" ")[0];
        data = input.substr(input.indexOf(' ')+1);
        
        if(type == "line") {
            
            if(data.includes(",")) {
                
                da1 = data.split(",")[0];
                da2 = data.split(",")[1];
                
                if(da1.includes(" ") && da2.includes(" ")) {
                    
                    dat1 = Number(da1.split(" ")[0]);
                    dat2 = Number(da1.split(" ")[1]);
                    dat3 = Number(da2.split(" ")[0]);
                    dat4 = Number(da2.split(" ")[1]);
                    
                    if(!isNaN(dat1) && !isNaN(dat2) && !isNaN(dat3) && !isNaN(dat4)) {
                    
                        ctx.beginPath();
                        ctx.moveTo(dat1, dat2);
                        ctx.lineTo(dat3, dat4);
                        ctx.stroke();
                        
                    }
                }
            }
            
        } else if(type == "rect") {
            
            if(data.includes(",")) {
                
                da1 = data.split(",")[0];
                da2 = data.split(",")[1];
                
                if(da1.includes(" ") && da2.includes(" ")) {
                    
                    dat1 = Number(da1.split(" ")[0]);
                    dat2 = Number(da1.split(" ")[1]);
                    dat3 = Number(da2.split(" ")[0]);
                    dat4 = Number(da2.split(" ")[1]);
                    
                    if(!isNaN(dat1) && !isNaN(dat2) && !isNaN(dat3) && !isNaN(dat4)) {
                    
                        ctx.fillRect(dat1, dat2, dat3, dat4)
                        
                    }
                }
            }
            
        } else if(type == "drawImg") {
            
            // comp:screen:drawImg ($image),data:x y,width height;
            
            if(data.includes(",data:")) {
                
                da1 = data.split(",data:")[0];
                da2 = data.split(",data:")[1];
                
                if(da2.includes(" ")) {
                    
                    dat1 = da1;                         // image data
                    dat_0 = da2.split(",")[0]
                    dat2 = Number(dat_0.split(" ")[0]);   // X position
                    dat3 = Number(dat_0.split(" ")[1]);   // Y position
                    dat_1 = da2.split(",")[1]         
                    dat4 = Number(dat_1.split(" ")[0]); // Width
                    dat5 = Number(dat_1.split(" ")[1]); // Height
                    
                    if(!isNaN(dat2) && !isNaN(dat3)) {
                    
                        window.img = new Image();
                        img.width = dat4;
                        img.height = dat5;
                        img.onload = function(){
                            
                            c2 = document.createElement("canvas")
                            ctx2 = c2.getContext("2d")
                            window.img2 = new Image();
                            img2.onload = function() {
                                
                                ctx.drawImage(img2, dat2, dat3, dat4, dat5); // img, X, Y, width, height
                                
                                
                            }
                            c2.width = dat4;
                            c2.height = dat5;
                            ctx2.drawImage(img, 0, 0, dat4, dat5);
                            img2.src = c2.toDataURL("image/png");
                            
                        }
                        img.src = dat1
                        
                    } else {
                        
                        console.log("err1", dat2, dat3, dat4, dat5)
                        
                    }
                } else {
                    
                    console.log("err2")
                    
                }
            } else {
                
                console.log("err3")
                
            }
            
        } else if(type == "getData") {
            
            lustla.setVar("#output", c.toDataURL());
            
        } else if(type == "setSize") {
            
            if(data.includes(" ")) {
                
                
                dat1 = Number(data.split(" ")[0]);
                dat2 = Number(data.split(" ")[1]);
                
                if(!isNaN(dat1) && !isNaN(dat2)) {
                
                    c.width = dat1;
                    c.height = dat2;
                    
                }
            }
            
            
        } else if(type == "pixelated") {
            if(data == "1") {
                
                c.setAttribute("style", `
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    image-rendering: -moz-crisp-edges;
    -ms-interpolation-mode: nearest-neighbor;`)
                
            } else if(data == "0") {
                
                c.removeAttribute("style");
                
            }
            
            
        } else if(type == "clear") {
            
            ctx.clearRect(0, 0, c.width, c.height);
            
        } else if(type == "getmousex") {
            
            //lustla.setVar("mousex", )
            
        }
        
    })
    
    setInterval(function(){
        
        if(lustla.usedComps.includes("screen")) {
            
            document.querySelector("body").classList.add("screenCompActive")
            
        } else {
            
            document.querySelector("body").classList.remove("screenCompActive")
            
        }
        
    })
    
}
</script>
